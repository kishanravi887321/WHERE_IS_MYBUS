<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üöå Complete Voice Bus Search - AI Pipeline</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 15px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }
    
    h1 {
      text-align: center;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      margin-bottom: 10px;
    }
    
    .subtitle {
      text-align: center;
      opacity: 0.9;
      margin-bottom: 30px;
      font-size: 16px;
    }
    
    .pipeline-steps {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .pipeline-step {
      background: rgba(255,255,255,0.1);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      backdrop-filter: blur(5px);
    }
    
    .step-active {
      background: rgba(76, 175, 80, 0.3);
      border: 2px solid rgba(76, 175, 80, 0.6);
    }
    
    .step-completed {
      background: rgba(33, 150, 243, 0.3);
      border: 2px solid rgba(33, 150, 243, 0.6);
    }
    
    .controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 30px 0;
    }
    
    button {
      padding: 15px 30px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    #start {
      background: linear-gradient(45deg, #4CAF50, #45a049);
      color: white;
    }
    
    #start:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
    }
    
    #stop {
      background: linear-gradient(45deg, #f44336, #da190b);
      color: white;
    }
    
    #stop:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
    }
    
    button:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
    }
    
    .result-section {
      background: rgba(255,255,255,0.1);
      border-radius: 15px;
      padding: 25px;
      margin: 20px 0;
      backdrop-filter: blur(10px);
    }
    
    .transcription-box {
      background: rgba(255,255,255,0.95);
      color: #333;
      padding: 20px;
      border-radius: 10px;
      margin: 15px 0;
      border-left: 4px solid #2196F3;
    }
    
    .route-display {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 20px;
      align-items: center;
      background: rgba(76, 175, 80, 0.2);
      padding: 25px;
      border-radius: 15px;
      margin: 20px 0;
      border: 2px solid rgba(76, 175, 80, 0.5);
    }
    
    .location-box {
      background: rgba(255,255,255,0.9);
      color: #333;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      font-weight: bold;
      font-size: 16px;
    }
    
    .source-box {
      border-left: 4px solid #4CAF50;
    }
    
    .destination-box {
      border-left: 4px solid #f44336;
    }
    
    .arrow {
      font-size: 30px;
      font-weight: bold;
      color: #4CAF50;
      text-align: center;
    }
    
    .bus-results {
      background: rgba(255,255,255,0.95);
      color: #333;
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .bus-card {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin: 15px 0;
      border-left: 4px solid #4CAF50;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .bus-header {
      display: flex;
      justify-content: between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .bus-number {
      font-size: 18px;
      font-weight: bold;
      color: #4CAF50;
    }
    
    .match-quality {
      padding: 4px 8px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: bold;
      text-transform: uppercase;
    }
    
    .excellent { background: #4CAF50; color: white; }
    .good { background: #2196F3; color: white; }
    .fair { background: #FF9800; color: white; }
    .poor { background: #f44336; color: white; }
    
    .route-stops {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0;
      font-size: 14px;
    }
    
    .stop {
      background: #e3f2fd;
      padding: 4px 8px;
      border-radius: 15px;
      color: #1976d2;
    }
    
    .stop-arrow {
      color: #666;
    }
    
    .status-section {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 15px 0;
      font-size: 16px;
    }
    
    #status {
      font-weight: bold;
    }
    
    .recording-indicator {
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background: #ff4444;
      animation: pulse 1s infinite;
      display: none;
    }
    
    .recording-indicator.active {
      display: block;
    }
    
    @keyframes pulse {
      0% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
      100% { opacity: 1; transform: scale(1); }
    }
    
    .examples {
      background: rgba(255,255,255,0.1);
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .example-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .example-item {
      padding: 15px;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      border-left: 4px solid #4CAF50;
    }
    
    .hindi-text {
      font-family: 'Devanagari Sangam MN', 'Noto Sans Devanagari', Arial Unicode MS;
      font-size: 16px;
    }
    
    .debug-info {
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      padding: 15px;
      margin-top: 20px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .no-results {
      text-align: center;
      padding: 30px;
      background: rgba(244, 67, 54, 0.1);
      border-radius: 10px;
      border: 2px solid rgba(244, 67, 54, 0.3);
    }
    
    .suggestions {
      background: rgba(255, 193, 7, 0.1);
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
      border: 1px solid rgba(255, 193, 7, 0.3);
    }
  </style>
</head>
<body>
  <h1>üöå Complete Voice Bus Search</h1>
  <div class="subtitle">Voice ‚Üí AI ‚Üí Bus Results ‚Ä¢ ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§î‡§∞ ‡§Ö‡§Ç‡§ó‡•ç‡§∞‡•á‡§ú‡•Ä ‚Ä¢ Complete Pipeline</div>
  
  <div class="pipeline-steps">
    <div class="pipeline-step" id="step1">
      <div>üé§</div>
      <div><strong>Step 1</strong><br>Voice Recording</div>
    </div>
    <div class="pipeline-step" id="step2">
      <div>ü§ñ</div>
      <div><strong>Step 2</strong><br>AI Transcription</div>
    </div>
    <div class="pipeline-step" id="step3">
      <div>üó∫Ô∏è</div>
      <div><strong>Step 3</strong><br>Route Extraction</div>
    </div>
    <div class="pipeline-step" id="step4">
      <div>üîç</div>
      <div><strong>Step 4</strong><br>Bus Search</div>
    </div>
  </div>
  
  <div class="controls">
    <button id="start">üéôÔ∏è Start Voice Search</button>
    <button id="stop" disabled>‚èπÔ∏è Stop Recording</button>
  </div>
  
  <div class="result-section">
    <h3>üéØ Voice Transcription:</h3>
    <div class="transcription-box" id="transcriptionOutput">
      Ready to process your voice bus search request...
    </div>
    
    <div id="routeDisplay" style="display: none;">
      <h3>üó∫Ô∏è Extracted Route:</h3>
      <div class="route-display">
        <div class="location-box source-box" id="sourceLocation">
          üìç Source
        </div>
        <div class="arrow">‚û°Ô∏è</div>
        <div class="location-box destination-box" id="destinationLocation">
          üéØ Destination
        </div>
      </div>
    </div>
    
    <div id="busResults" style="display: none;">
      <h3>üöå Available Buses:</h3>
      <div class="bus-results" id="busResultsContainer">
        <!-- Bus results will be populated here -->
      </div>
    </div>
  </div>
  
  <div class="status-section">
    <strong>Status:</strong> 
    <span id="status">Ready to record</span>
    <div class="recording-indicator" id="recordingIndicator"></div>
  </div>
  
  <div class="examples">
    <h3>üí° Try These Voice Commands:</h3>
    <div class="example-grid">
      <div class="example-item">
        <strong>Hindi:</strong><br>
        <span class="hindi-text">"‡§Æ‡•Å‡§ù‡•á ‡§¶‡§ø‡§≤‡•ç‡§≤‡•Ä ‡§∏‡•á ‡§Æ‡•Å‡§Ç‡§¨‡§à ‡§ï‡•Ä bus ‡§ö‡§æ‡§π‡§ø‡§è"</span><br>
        <small>Find buses: Delhi ‚Üí Mumbai</small>
      </div>
      <div class="example-item">
        <strong>English:</strong><br>
        "I need a bus from Bangalore to Chennai"<br>
        <small>Find buses: Bangalore ‚Üí Chennai</small>
      </div>
      <div class="example-item">
        <strong>Mixed:</strong><br>
        <span class="hindi-text">"Pune ‡§∏‡•á Nashik ‡§ú‡§æ‡§®‡•á ‡§µ‡§æ‡§≤‡•Ä bus"</span><br>
        <small>Find buses: Pune ‚Üí Nashik</small>
      </div>
      <div class="example-item">
        <strong>Simple:</strong><br>
        <span class="hindi-text">"Goa ‡§ï‡•Ä bus ‡§¶‡§ø‡§ñ‡§æ‡§ì"</span><br>
        <small>Find buses to Goa</small>
      </div>
    </div>
  </div>
  
  <div class="debug-info" id="debugInfo">
    <strong>üîç Debug Log:</strong><br>
  </div>

  <script>
    let mediaRecorder;
    let audioChunks = [];
    const startBtn = document.getElementById("start");
    const stopBtn = document.getElementById("stop");
    const transcriptionOutput = document.getElementById("transcriptionOutput");
    const status = document.getElementById("status");
    const recordingIndicator = document.getElementById("recordingIndicator");
    const debugInfo = document.getElementById("debugInfo");
    const routeDisplay = document.getElementById("routeDisplay");
    const sourceLocation = document.getElementById("sourceLocation");
    const destinationLocation = document.getElementById("destinationLocation");
    const busResults = document.getElementById("busResults");
    const busResultsContainer = document.getElementById("busResultsContainer");

    // Pipeline step elements
    const step1 = document.getElementById("step1");
    const step2 = document.getElementById("step2");
    const step3 = document.getElementById("step3");
    const step4 = document.getElementById("step4");

    function addDebugLog(message) {
      const timestamp = new Date().toLocaleTimeString();
      debugInfo.innerHTML += `[${timestamp}] ${message}<br>`;
      debugInfo.scrollTop = debugInfo.scrollHeight;
    }

    function updatePipelineStep(stepNum, status) {
      const steps = [step1, step2, step3, step4];
      
      // Reset all steps
      steps.forEach((step, index) => {
        step.className = 'pipeline-step';
        if (index < stepNum - 1) {
          step.className += ' step-completed';
        } else if (index === stepNum - 1) {
          step.className += ` step-${status}`;
        }
      });
    }

    function displayRoute(data) {
      if (data.destinations) {
        sourceLocation.innerHTML = `
          üìç <strong>From:</strong><br>
          ${data.destinations.source}
        `;
        
        destinationLocation.innerHTML = `
          üéØ <strong>To:</strong><br>
          ${data.destinations.destination}
        `;
        
        routeDisplay.style.display = "block";
      }
    }

    function displayBusResults(busSearch) {
      if (!busSearch || !busSearch.results || busSearch.results.length === 0) {
        if (busSearch && busSearch.suggestions) {
          busResultsContainer.innerHTML = `
            <div class="no-results">
              <h3>‚ùå No Buses Found</h3>
              <p>${busSearch.message}</p>
              
              ${busSearch.suggestions.availableLocations ? `
                <div class="suggestions">
                  <strong>üí° Available Locations:</strong><br>
                  ${busSearch.suggestions.availableLocations.join(', ')}
                </div>
              ` : ''}
              
              ${busSearch.suggestions.searchTips ? `
                <div class="suggestions">
                  <strong>üîç Search Tips:</strong><br>
                  <ul style="text-align: left; margin: 10px 0;">
                    ${busSearch.suggestions.searchTips.map(tip => `<li>${tip}</li>`).join('')}
                  </ul>
                </div>
              ` : ''}
            </div>
          `;
        } else {
          busResultsContainer.innerHTML = `
            <div class="no-results">
              <h3>‚ùå No Buses Found</h3>
              <p>No buses found for this route. Please try a different route.</p>
            </div>
          `;
        }
        busResults.style.display = "block";
        return;
      }

      // Display bus results
      const busCards = busSearch.results.map(bus => `
        <div class="bus-card">
          <div class="bus-header">
            <div>
              <div class="bus-number">üöå ${bus.busNumber}</div>
              <div style="color: #666; font-size: 14px;">${bus.routeName}</div>
            </div>
            <span class="match-quality ${bus.matchQuality}">${bus.matchQuality}</span>
          </div>
          
          <div style="margin: 10px 0;">
            <strong>üë®‚Äç‚úàÔ∏è Driver:</strong> ${bus.driverName} | <strong>üì± Phone:</strong> ${bus.driverPhone}
          </div>
          
          <div style="margin: 10px 0;">
            <strong>üë• Capacity:</strong> ${bus.capacity} passengers | 
            <strong>üîó Bus ID:</strong> ${bus.busId}
          </div>
          
          <div class="route-stops">
            ${bus.route.fullRoute.map((stop, index) => 
              index === bus.route.fullRoute.length - 1 ? 
              `<span class="stop">${stop}</span>` : 
              `<span class="stop">${stop}</span><span class="stop-arrow">‚Üí</span>`
            ).join('')}
          </div>
          
          <div style="margin-top: 15px; font-size: 12px; color: #666;">
            <strong>Match Score:</strong> ${(bus.matchScore * 100).toFixed(1)}% | 
            <strong>Match Type:</strong> ${bus.matchType}
          </div>
        </div>
      `).join('');

      busResultsContainer.innerHTML = `
        <div style="margin-bottom: 20px; padding: 15px; background: #e8f5e8; border-radius: 10px;">
          <strong>‚úÖ ${busSearch.count} bus(es) found!</strong><br>
          <small>${busSearch.message}</small>
        </div>
        ${busCards}
      `;

      busResults.style.display = "block";
    }

    startBtn.addEventListener("click", async () => {
      try {
        addDebugLog("üé§ Starting voice bus search pipeline...");
        status.textContent = "Requesting microphone access...";
        updatePipelineStep(1, 'active');
        routeDisplay.style.display = "none";
        busResults.style.display = "none";
        
        const stream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true,
            sampleRate: 48000,
            channelCount: 1
          } 
        });

        addDebugLog("‚úÖ Microphone access granted");

        let mimeType = 'audio/webm;codecs=opus';
        if (!MediaRecorder.isTypeSupported(mimeType)) {
          mimeType = 'audio/webm';
          if (!MediaRecorder.isTypeSupported(mimeType)) {
            mimeType = 'audio/wav';
          }
        }

        addDebugLog(`üéµ Using audio format: ${mimeType}`);

        const options = mimeType ? { mimeType } : {};
        mediaRecorder = new MediaRecorder(stream, options);
        audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            audioChunks.push(event.data);
            addDebugLog(`üìä Audio chunk: ${event.data.size} bytes`);
          }
        };

        mediaRecorder.onstop = async () => {
          addDebugLog("üõë Recording stopped, starting AI processing...");
          updatePipelineStep(2, 'active');
          
          const audioBlob = new Blob(audioChunks, { 
            type: mediaRecorder.mimeType || 'audio/webm' 
          });
          
          addDebugLog(`üìÅ Audio blob created: ${audioBlob.size} bytes`);

          const formData = new FormData();
          formData.append("audio", audioBlob, "voice-bus-search.webm");

          try {
            status.textContent = "ü§ñ Processing with complete AI pipeline...";
            transcriptionOutput.innerHTML = `
              <div style="text-align: center;">
                <h4>üîÑ AI Processing Pipeline</h4>
                <p>üé§ Voice ‚Üí ü§ñ Transcription ‚Üí üó∫Ô∏è Route Extraction ‚Üí üîç Bus Search</p>
                <small>This may take 10-15 seconds...</small>
              </div>
            `;

            addDebugLog("üöÄ Sending to complete voice-to-bus pipeline...");

            const response = await fetch("http://localhost:5001/api/chatbot/transcribe", {
              method: "POST",
              body: formData,
            });

            addDebugLog(`üì° Response status: ${response.status}`);

            if (!response.ok) {
              const errorText = await response.text();
              addDebugLog(`‚ùå Response error: ${errorText}`);
              throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const data = await response.json();
            addDebugLog(`‚úÖ Complete Response: ${JSON.stringify(data, null, 2)}`);

            if (data.success && data.data) {
              updatePipelineStep(2, 'completed');
              updatePipelineStep(3, 'active');

              // Display transcription
              const transcription = data.data.transcription;
              transcriptionOutput.innerHTML = `
                <div>
                  <strong>üéØ What you said:</strong><br>
                  <div style="font-size: 18px; margin: 10px 0; padding: 15px; background: rgba(33, 150, 243, 0.1); border-radius: 8px; ${transcription.language && (transcription.language.toLowerCase().includes('hindi') || transcription.language.includes('hi')) ? 'font-family: Devanagari Sangam MN, Noto Sans Devanagari, Arial Unicode MS;' : ''}">
                    "${transcription.text}"
                  </div>
                  <small><strong>Language:</strong> ${transcription.language} | <strong>Model:</strong> ${transcription.model}</small>
                </div>
              `;

              updatePipelineStep(3, 'completed');
              updatePipelineStep(4, 'active');

              // Display route extraction
              displayRoute(data.data);

              // Display bus search results
              setTimeout(() => {
                updatePipelineStep(4, 'completed');
                
                if (data.data.busSearch) {
                  displayBusResults(data.data.busSearch);
                  
                  if (data.data.busSearch.success && data.data.busSearch.count > 0) {
                    status.textContent = `‚úÖ Found ${data.data.busSearch.count} bus(es)!`;
                  } else {
                    status.textContent = "‚ö†Ô∏è No buses found for this route";
                  }
                } else {
                  status.textContent = "‚ö†Ô∏è Route extraction incomplete";
                }
              }, 500);

              addDebugLog(`üó∫Ô∏è Route: ${data.data.destinations.source} ‚Üí ${data.data.destinations.destination}`);
              if (data.data.busSearch) {
                addDebugLog(`üöå Buses found: ${data.data.busSearch.count || 0}`);
              }
              
            } else {
              throw new Error(data.error || data.message || "Processing failed");
            }

          } catch (error) {
            addDebugLog(`‚ùå Pipeline error: ${error.message}`);
            transcriptionOutput.innerHTML = `
              <div style="color: #ff4444; text-align: center;">
                <strong>‚ùå Error:</strong><br>
                ${error.message}<br><br>
                <small>Check the debug log below for details</small>
              </div>
            `;
            status.textContent = "‚ùå Processing failed";
            updatePipelineStep(1, 'active'); // Reset to start
          }

          // Cleanup
          stream.getTracks().forEach(track => {
            track.stop();
            addDebugLog("üîá Microphone stopped");
          });

          recordingIndicator.classList.remove('active');
        };

        mediaRecorder.onerror = (event) => {
          addDebugLog(`üî¥ MediaRecorder error: ${event.error}`);
          status.textContent = "‚ùå Recording error: " + event.error;
        };

        // Start recording
        addDebugLog("‚ñ∂Ô∏è Starting recording for complete bus search...");
        mediaRecorder.start(1000);
        
        startBtn.disabled = true;
        stopBtn.disabled = false;
        status.textContent = "üî¥ Recording your bus search request...";
        transcriptionOutput.innerHTML = `
          <div style="text-align: center; font-size: 18px;">
            üéôÔ∏è <strong>Listening...</strong><br>
            <div style="margin-top: 15px;">
              <div class="hindi-text">‡§Ö‡§™‡§®‡§æ bus route ‡§¨‡§§‡§æ‡§è‡§Ç</div>
              <div style="opacity: 0.8;">Tell us your bus route</div>
            </div>
          </div>
        `;
        recordingIndicator.classList.add('active');

      } catch (error) {
        addDebugLog(`‚ùå Microphone error: ${error.message}`);
        status.textContent = "‚ùå Microphone error: " + error.message;
        transcriptionOutput.textContent = "Please allow microphone access and try again.";
        updatePipelineStep(1, 'active');
      }
    });

    stopBtn.addEventListener("click", () => {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        addDebugLog("‚èπÔ∏è User stopped recording");
        mediaRecorder.stop();
        startBtn.disabled = false;
        stopBtn.disabled = true;
        status.textContent = "‚è≥ Processing complete voice-to-bus pipeline...";
        recordingIndicator.classList.remove('active');
      }
    });

    // Initialize
    window.addEventListener('load', async () => {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const audioInputs = devices.filter(device => device.kind === 'audioinput');
        addDebugLog(`üé§ Audio inputs available: ${audioInputs.length}`);
        addDebugLog("ü§ñ Complete AI Pipeline: Voice ‚Üí Transcription ‚Üí Route ‚Üí Bus Search");
        addDebugLog("üåç Languages: Hindi + English auto-detection");
        addDebugLog("üîç Search: Advanced fuzzy matching with multiple strategies");
        
        if (audioInputs.length === 0) {
          status.textContent = "‚ùå No microphone detected";
          startBtn.disabled = true;
        }
      } catch (error) {
        addDebugLog(`‚ö†Ô∏è Device check error: ${error.message}`);
      }
    });
  </script>
</body>
</html>
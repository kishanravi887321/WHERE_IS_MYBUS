<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üé§ Bus Route Voice Search - AI Destination Extraction</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1000px;
      margin: 20px auto;
      padding: 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 15px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }
    
    h1 {
      text-align: center;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      margin-bottom: 10px;
    }
    
    .subtitle {
      text-align: center;
      opacity: 0.9;
      margin-bottom: 30px;
      font-size: 16px;
    }
    
    .controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 30px;
    }
    
    button {
      padding: 15px 30px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    #start {
      background: linear-gradient(45deg, #4CAF50, #45a049);
      color: white;
    }
    
    #start:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
    }
    
    #stop {
      background: linear-gradient(45deg, #f44336, #da190b);
      color: white;
    }
    
    #stop:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
    }
    
    button:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
    }
    
    .result-section {
      background: rgba(255,255,255,0.1);
      border-radius: 15px;
      padding: 25px;
      margin: 20px 0;
      backdrop-filter: blur(10px);
    }
    
    .transcription-box {
      background: rgba(255,255,255,0.95);
      color: #333;
      padding: 20px;
      border-radius: 10px;
      margin: 15px 0;
      font-size: 16px;
      line-height: 1.5;
      border-left: 4px solid #2196F3;
    }
    
    .route-display {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 20px;
      align-items: center;
      background: rgba(76, 175, 80, 0.2);
      padding: 25px;
      border-radius: 15px;
      margin: 20px 0;
      border: 2px solid rgba(76, 175, 80, 0.5);
    }
    
    .location-box {
      background: rgba(255,255,255,0.9);
      color: #333;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      font-weight: bold;
      font-size: 18px;
    }
    
    .source-box {
      border-left: 4px solid #4CAF50;
    }
    
    .destination-box {
      border-left: 4px solid #f44336;
    }
    
    .arrow {
      font-size: 30px;
      font-weight: bold;
      color: #4CAF50;
      text-align: center;
    }
    
    .status-section {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 15px 0;
      font-size: 16px;
    }
    
    #status {
      font-weight: bold;
    }
    
    .recording-indicator {
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background: #ff4444;
      animation: pulse 1s infinite;
      display: none;
    }
    
    .recording-indicator.active {
      display: block;
    }
    
    @keyframes pulse {
      0% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
      100% { opacity: 1; transform: scale(1); }
    }
    
    .examples {
      background: rgba(255,255,255,0.1);
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .example-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .example-item {
      padding: 15px;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      border-left: 4px solid #4CAF50;
    }
    
    .hindi-text {
      font-family: 'Devanagari Sangam MN', 'Noto Sans Devanagari', Arial Unicode MS;
      font-size: 16px;
    }
    
    .debug-info {
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      padding: 15px;
      margin-top: 20px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .route-status {
      text-align: center;
      margin: 15px 0;
      padding: 10px;
      border-radius: 8px;
      font-weight: bold;
    }
    
    .route-valid {
      background: rgba(76, 175, 80, 0.3);
      border: 1px solid rgba(76, 175, 80, 0.6);
      color: #4CAF50;
    }
    
    .route-invalid {
      background: rgba(244, 67, 54, 0.3);
      border: 1px solid rgba(244, 67, 54, 0.6);
      color: #f44336;
    }
  </style>
</head>
<body>
  <h1>üöå Bus Route Voice Search</h1>
  <div class="subtitle">AI-Powered Destination Extraction ‚Ä¢ ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§î‡§∞ ‡§Ö‡§Ç‡§ó‡•ç‡§∞‡•á‡§ú‡•Ä ‚Ä¢ Hindi & English</div>
  
  <div class="controls">
    <button id="start">üéôÔ∏è Start Recording</button>
    <button id="stop" disabled>‚èπÔ∏è Stop Recording</button>
  </div>
  
  <div class="result-section">
    <h3>üìù Voice Transcription:</h3>
    <div class="transcription-box" id="transcriptionOutput">
      Ready to listen for your bus route request...
    </div>
    
    <div id="routeDisplay" style="display: none;">
      <h3>üó∫Ô∏è Extracted Route:</h3>
      <div class="route-display">
        <div class="location-box source-box" id="sourceLocation">
          üìç Source
        </div>
        <div class="arrow">‚û°Ô∏è</div>
        <div class="location-box destination-box" id="destinationLocation">
          üéØ Destination
        </div>
      </div>
      <div class="route-status" id="routeStatus"></div>
    </div>
  </div>
  
  <div class="status-section">
    <strong>Status:</strong> 
    <span id="status">Ready to record</span>
    <div class="recording-indicator" id="recordingIndicator"></div>
  </div>
  
  <div class="examples">
    <h3>üí° Try These Voice Commands:</h3>
    <div class="example-grid">
      <div class="example-item">
        <strong>Hindi:</strong><br>
        <span class="hindi-text">"‡§Æ‡•Å‡§ù‡•á ‡§¶‡§ø‡§≤‡•ç‡§≤‡•Ä ‡§∏‡•á ‡§Æ‡•Å‡§Ç‡§¨‡§à ‡§ú‡§æ‡§®‡§æ ‡§π‡•à"</span><br>
        <small>Extract: Delhi ‚Üí Mumbai</small>
      </div>
      <div class="example-item">
        <strong>English:</strong><br>
        "I want to go from Bangalore to Chennai"<br>
        <small>Extract: Bangalore ‚Üí Chennai</small>
      </div>
      <div class="example-item">
        <strong>Mixed:</strong><br>
        <span class="hindi-text">"Pune ‡§∏‡•á Nashik ‡§ï‡§æ bus"</span><br>
        <small>Extract: Pune ‚Üí Nashik</small>
      </div>
      <div class="example-item">
        <strong>Destination Only:</strong><br>
        <span class="hindi-text">"‡§Æ‡•Å‡§ù‡•á Goa ‡§ú‡§æ‡§®‡§æ ‡§π‡•à"</span><br>
        <small>Extract: Current Location ‚Üí Goa</small>
      </div>
    </div>
  </div>
  
  <div class="debug-info" id="debugInfo">
    <strong>üîç Debug Log:</strong><br>
  </div>

  <script>
    let mediaRecorder;
    let audioChunks = [];
    const startBtn = document.getElementById("start");
    const stopBtn = document.getElementById("stop");
    const transcriptionOutput = document.getElementById("transcriptionOutput");
    const status = document.getElementById("status");
    const recordingIndicator = document.getElementById("recordingIndicator");
    const debugInfo = document.getElementById("debugInfo");
    const routeDisplay = document.getElementById("routeDisplay");
    const sourceLocation = document.getElementById("sourceLocation");
    const destinationLocation = document.getElementById("destinationLocation");
    const routeStatus = document.getElementById("routeStatus");

    function addDebugLog(message) {
      const timestamp = new Date().toLocaleTimeString();
      debugInfo.innerHTML += `[${timestamp}] ${message}<br>`;
      debugInfo.scrollTop = debugInfo.scrollHeight;
    }

    function displayRoute(data) {
      if (data.destinations) {
        sourceLocation.innerHTML = `
          üìç <strong>From:</strong><br>
          ${data.destinations.source}
        `;
        
        destinationLocation.innerHTML = `
          üéØ <strong>To:</strong><br>
          ${data.destinations.destination}
        `;
        
        if (data.destinations.isValidRoute) {
          routeStatus.className = "route-status route-valid";
          routeStatus.innerHTML = "‚úÖ Valid Route - Ready for Bus Search!";
        } else {
          routeStatus.className = "route-status route-invalid";
          routeStatus.innerHTML = "‚ö†Ô∏è Route Unclear - Please specify both source and destination";
        }
        
        routeDisplay.style.display = "block";
      }
    }

    startBtn.addEventListener("click", async () => {
      try {
        addDebugLog("üé§ Requesting microphone access...");
        status.textContent = "Requesting microphone access...";
        routeDisplay.style.display = "none";
        
        const stream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true,
            sampleRate: 48000,
            channelCount: 1
          } 
        });

        addDebugLog("‚úÖ Microphone access granted");

        let mimeType = 'audio/webm;codecs=opus';
        if (!MediaRecorder.isTypeSupported(mimeType)) {
          mimeType = 'audio/webm';
          if (!MediaRecorder.isTypeSupported(mimeType)) {
            mimeType = 'audio/wav';
          }
        }

        addDebugLog(`üéµ Using MIME type: ${mimeType}`);

        const options = mimeType ? { mimeType } : {};
        mediaRecorder = new MediaRecorder(stream, options);
        audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            audioChunks.push(event.data);
            addDebugLog(`üìä Audio chunk: ${event.data.size} bytes`);
          }
        };

        mediaRecorder.onstop = async () => {
          addDebugLog("üõë Recording stopped, processing...");
          
          const audioBlob = new Blob(audioChunks, { 
            type: mediaRecorder.mimeType || 'audio/webm' 
          });
          
          addDebugLog(`üìÅ Audio blob: ${audioBlob.size} bytes`);

          const formData = new FormData();
          formData.append("audio", audioBlob, "route-recording.webm");

          try {
            status.textContent = "ü§ñ Processing with AI destination extraction...";
            transcriptionOutput.innerHTML = `
              <div style="text-align: center;">
                üîÑ Analyzing your route request with Gemini AI...<br>
                <small>Extracting source and destination</small>
              </div>
            `;

            addDebugLog("üöÄ Sending for route extraction...");

            const response = await fetch("http://localhost:5001/api/chatbot/transcribe", {
              method: "POST",
              body: formData,
            });

            addDebugLog(`üì° Response status: ${response.status}`);

            if (!response.ok) {
              const errorText = await response.text();
              addDebugLog(`‚ùå Response error: ${errorText}`);
              throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const data = await response.json();
            addDebugLog(`‚úÖ Full Response: ${JSON.stringify(data, null, 2)}`);

            if (data.success && data.data) {
              // Display transcription
              const transcription = data.data.transcription;
              transcriptionOutput.innerHTML = `
                <div>
                  <strong>üéØ What you said:</strong><br>
                  <div style="font-size: 18px; margin: 10px 0; padding: 10px; background: rgba(33, 150, 243, 0.1); border-radius: 5px; ${transcription.language && (transcription.language.toLowerCase().includes('hindi') || transcription.language.includes('hi')) ? 'font-family: Devanagari Sangam MN, Noto Sans Devanagari, Arial Unicode MS;' : ''}">
                    "${transcription.text}"
                  </div>
                  <small><strong>Language:</strong> ${transcription.language} | <strong>Model:</strong> ${transcription.model}</small>
                </div>
              `;

              // Display route
              displayRoute(data.data);

              status.textContent = data.data.destinations.isValidRoute ? 
                `‚úÖ Route extracted successfully!` : 
                `‚ö†Ô∏è Route unclear - please try again`;

              addDebugLog(`üó∫Ô∏è Route: ${data.data.destinations.source} ‚Üí ${data.data.destinations.destination}`);
              
            } else {
              throw new Error(data.error || data.message || "Processing failed");
            }

          } catch (error) {
            addDebugLog(`‚ùå Processing error: ${error.message}`);
            transcriptionOutput.innerHTML = `
              <div style="color: #ff4444; text-align: center;">
                <strong>‚ùå Error:</strong><br>
                ${error.message}<br><br>
                <small>Check the debug log below for details</small>
              </div>
            `;
            status.textContent = "‚ùå Processing failed";
            routeDisplay.style.display = "none";
          }

          // Cleanup
          stream.getTracks().forEach(track => {
            track.stop();
            addDebugLog("üîá Microphone stopped");
          });

          recordingIndicator.classList.remove('active');
        };

        mediaRecorder.onerror = (event) => {
          addDebugLog(`üî¥ MediaRecorder error: ${event.error}`);
          status.textContent = "‚ùå Recording error: " + event.error;
        };

        // Start recording
        addDebugLog("‚ñ∂Ô∏è Starting recording for route extraction...");
        mediaRecorder.start(1000);
        
        startBtn.disabled = true;
        stopBtn.disabled = false;
        status.textContent = "üî¥ Recording... (Route extraction enabled)";
        transcriptionOutput.innerHTML = `
          <div style="text-align: center; font-size: 18px;">
            üéôÔ∏è <strong>Listening for your bus route...</strong><br>
            <div style="margin-top: 15px;">
              <div class="hindi-text">‡§ï‡§π‡§æ‡§Å ‡§∏‡•á ‡§ï‡§π‡§æ‡§Å ‡§ú‡§æ‡§®‡§æ ‡§π‡•à ‡§¨‡§§‡§æ‡§è‡§Ç</div>
              <div style="opacity: 0.8;">Tell us your source and destination</div>
            </div>
          </div>
        `;
        recordingIndicator.classList.add('active');

      } catch (error) {
        addDebugLog(`‚ùå Microphone error: ${error.message}`);
        status.textContent = "‚ùå Microphone error: " + error.message;
        transcriptionOutput.textContent = "Please allow microphone access and try again.";
      }
    });

    stopBtn.addEventListener("click", () => {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        addDebugLog("‚èπÔ∏è User stopped recording");
        mediaRecorder.stop();
        startBtn.disabled = false;
        stopBtn.disabled = true;
        status.textContent = "‚è≥ Processing route extraction...";
        recordingIndicator.classList.remove('active');
      }
    });

    // Initialize
    window.addEventListener('load', async () => {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const audioInputs = devices.filter(device => device.kind === 'audioinput');
        addDebugLog(`üé§ Audio inputs available: ${audioInputs.length}`);
        addDebugLog("ü§ñ AI Route Extraction: Enabled (Gemini + ElevenLabs)");
        addDebugLog("üåç Languages: Hindi + English auto-detection");
        
        if (audioInputs.length === 0) {
          status.textContent = "‚ùå No microphone detected";
          startBtn.disabled = true;
        }
      } catch (error) {
        addDebugLog(`‚ö†Ô∏è Device check error: ${error.message}`);
      }
    });
  </script>
</body>
</html>
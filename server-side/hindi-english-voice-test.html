<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üé§ Hindi-English Voice Recognition</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 900px;
      margin: 30px auto;
      padding: 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 15px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }
    
    h1 {
      text-align: center;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      margin-bottom: 10px;
    }
    
    .subtitle {
      text-align: center;
      opacity: 0.9;
      margin-bottom: 30px;
      font-size: 16px;
    }
    
    .controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 30px;
    }
    
    button {
      padding: 15px 30px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    #start {
      background: linear-gradient(45deg, #4CAF50, #45a049);
      color: white;
    }
    
    #start:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
    }
    
    #stop {
      background: linear-gradient(45deg, #f44336, #da190b);
      color: white;
    }
    
    #stop:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
    }
    
    button:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
    }
    
    .output-section {
      background: rgba(255,255,255,0.1);
      border-radius: 15px;
      padding: 25px;
      margin: 20px 0;
      backdrop-filter: blur(10px);
    }
    
    #output {
      background: rgba(255,255,255,0.95);
      color: #333;
      padding: 25px;
      border-radius: 10px;
      min-height: 80px;
      margin: 15px 0;
      font-size: 18px;
      line-height: 1.6;
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
      border-left: 4px solid #4CAF50;
    }
    
    .language-info {
      background: rgba(255,255,255,0.1);
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .status-section {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 15px 0;
      font-size: 16px;
    }
    
    #status {
      font-weight: bold;
    }
    
    .recording-indicator {
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background: #ff4444;
      animation: pulse 1s infinite;
      display: none;
    }
    
    .recording-indicator.active {
      display: block;
    }
    
    @keyframes pulse {
      0% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
      100% { opacity: 1; transform: scale(1); }
    }
    
    .examples {
      background: rgba(255,255,255,0.1);
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .example-item {
      margin: 10px 0;
      padding: 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 5px;
    }
    
    .debug-info {
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      padding: 15px;
      margin-top: 20px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 250px;
      overflow-y: auto;
    }
    
    .hindi-text {
      font-family: 'Devanagari Sangam MN', 'Noto Sans Devanagari', Arial Unicode MS;
    }
  </style>
</head>
<body>
  <h1>üé§ Hindi-English Voice Recognition</h1>
  <div class="subtitle">‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§î‡§∞ ‡§Ö‡§Ç‡§ó‡•ç‡§∞‡•á‡§ú‡•Ä ‡§Æ‡•á‡§Ç ‡§¨‡•ã‡§≤‡•á‡§Ç ‚Ä¢ Speak in Hindi or English</div>
  
  <div class="controls">
    <button id="start">üéôÔ∏è Start Recording</button>
    <button id="stop" disabled>‚èπÔ∏è Stop Recording</button>
  </div>
  
  <div class="output-section">
    <h3>üìù Transcription Result:</h3>
    <div id="output">Ready to transcribe Hindi or English speech...</div>
    
    <div class="language-info" id="languageInfo" style="display: none;">
      <div>
        <strong>üåç Detected Language:</strong> <span id="detectedLang">-</span>
      </div>
      <div>
        <strong>ü§ñ Model:</strong> <span id="modelUsed">-</span>
      </div>
    </div>
  </div>
  
  <div class="status-section">
    <strong>Status:</strong> 
    <span id="status">Ready to record</span>
    <div class="recording-indicator" id="recordingIndicator"></div>
  </div>
  
  <div class="examples">
    <h3>üí° Try These Examples:</h3>
    <div class="example-item"><strong>Hindi:</strong> <span class="hindi-text">"‡§Æ‡•Å‡§ù‡•á ‡§¶‡§ø‡§≤‡•ç‡§≤‡•Ä ‡§∏‡•á ‡§Æ‡•Å‡§Ç‡§¨‡§à ‡§ú‡§æ‡§®‡§æ ‡§π‡•à"</span></div>
    <div class="example-item"><strong>English:</strong> "I want to go from Delhi to Mumbai"</div>
    <div class="example-item"><strong>Mixed:</strong> <span class="hindi-text">"Delhi ‡§∏‡•á Bangalore ‡§ï‡§æ bus ‡§ï‡§¨ ‡§π‡•à?"</span></div>
    <div class="example-item"><strong>Hindi:</strong> <span class="hindi-text">"‡§ï‡§≤ ‡§∏‡•Å‡§¨‡§π 8 ‡§¨‡§ú‡•á ‡§ï‡•Ä bus book ‡§ï‡§∞‡•ã"</span></div>
  </div>
  
  <div class="debug-info" id="debugInfo">
    <strong>üîç Debug Log:</strong><br>
  </div>

  <script>
    let mediaRecorder;
    let audioChunks = [];
    const startBtn = document.getElementById("start");
    const stopBtn = document.getElementById("stop");
    const output = document.getElementById("output");
    const status = document.getElementById("status");
    const recordingIndicator = document.getElementById("recordingIndicator");
    const debugInfo = document.getElementById("debugInfo");
    const languageInfo = document.getElementById("languageInfo");
    const detectedLang = document.getElementById("detectedLang");
    const modelUsed = document.getElementById("modelUsed");

    function addDebugLog(message) {
      const timestamp = new Date().toLocaleTimeString();
      debugInfo.innerHTML += `[${timestamp}] ${message}<br>`;
      debugInfo.scrollTop = debugInfo.scrollHeight;
    }

    startBtn.addEventListener("click", async () => {
      try {
        addDebugLog("üé§ Requesting microphone access...");
        status.textContent = "Requesting microphone access...";
        languageInfo.style.display = "none";
        
        // Request microphone access optimized for speech
        const stream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true,
            sampleRate: 48000,
            channelCount: 1 // Mono for speech recognition
          } 
        });

        addDebugLog("‚úÖ Microphone access granted");

        // Use the best available codec
        let mimeType = 'audio/webm;codecs=opus';
        if (!MediaRecorder.isTypeSupported(mimeType)) {
          mimeType = 'audio/webm';
          if (!MediaRecorder.isTypeSupported(mimeType)) {
            mimeType = 'audio/wav';
          }
        }

        addDebugLog(`üéµ Using MIME type: ${mimeType}`);

        const options = mimeType ? { mimeType } : {};
        mediaRecorder = new MediaRecorder(stream, options);
        audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            audioChunks.push(event.data);
            addDebugLog(`üìä Audio chunk: ${event.data.size} bytes`);
          }
        };

        mediaRecorder.onstop = async () => {
          addDebugLog("üõë Recording stopped, processing...");
          
          const audioBlob = new Blob(audioChunks, { 
            type: mediaRecorder.mimeType || 'audio/webm' 
          });
          
          addDebugLog(`üìÅ Audio blob: ${audioBlob.size} bytes, type: ${audioBlob.type}`);

          const formData = new FormData();
          formData.append("audio", audioBlob, "recording.webm");

          try {
            status.textContent = "üîÑ Processing with Hindi-English detection...";
            output.textContent = "ü§ñ Analyzing audio with ElevenLabs (Hindi/English)...";

            addDebugLog("üöÄ Sending to backend for Hindi/English transcription...");

            const response = await fetch("http://localhost:5001/api/chatbot/transcribe", {
              method: "POST",
              body: formData,
            });

            addDebugLog(`üì° Response status: ${response.status}`);

            if (!response.ok) {
              const errorText = await response.text();
              addDebugLog(`‚ùå Response error: ${errorText}`);
              throw new Error(`HTTP ${response.status}: ${errorText}`);
            }

            const data = await response.json();
            addDebugLog(`‚úÖ Response: ${JSON.stringify(data, null, 2)}`);

            if (data.success && data.data) {
              const transcribedText = data.data.text || "No text detected";
              const language = data.data.language || 'Unknown';
              
              // Display result with language-specific styling
              output.innerHTML = `
                <div style="font-size: 20px; margin-bottom: 15px;">
                  <strong>Transcribed Text:</strong>
                </div>
                <div style="font-size: 24px; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; ${language.toLowerCase().includes('hindi') || language.includes('hi') ? 'font-family: Devanagari Sangam MN, Noto Sans Devanagari, Arial Unicode MS;' : ''}" class="${language.toLowerCase().includes('hindi') || language.includes('hi') ? 'hindi-text' : ''}">
                  "${transcribedText}"
                </div>
              `;
              
              // Show language detection info
              languageInfo.style.display = "flex";
              detectedLang.textContent = language + (language.toLowerCase().includes('hindi') || language.includes('hi') ? ' üáÆüá≥' : language.toLowerCase().includes('english') || language.includes('en') ? ' üá∫üá∏' : '');
              modelUsed.textContent = data.data.model_used + " (Multi-language)";
              
              status.textContent = `‚úÖ Transcription complete! (${language})`;
              addDebugLog(`üéØ Final result (${language}): "${transcribedText}"`);
            } else {
              throw new Error(data.error || data.message || "Transcription failed");
            }

          } catch (error) {
            addDebugLog(`‚ùå Transcription error: ${error.message}`);
            output.innerHTML = `
              <div style="color: #ff4444;">
                <strong>‚ùå Error:</strong><br>
                ${error.message}<br><br>
                <small>Please check the debug log below for more details.</small>
              </div>
            `;
            status.textContent = "‚ùå Transcription failed";
            languageInfo.style.display = "none";
          }

          // Clean up microphone stream
          stream.getTracks().forEach(track => {
            track.stop();
            addDebugLog("üîá Microphone stopped");
          });

          recordingIndicator.classList.remove('active');
        };

        mediaRecorder.onerror = (event) => {
          addDebugLog(`üî¥ MediaRecorder error: ${event.error}`);
          status.textContent = "‚ùå Recording error: " + event.error;
        };

        // Start recording
        addDebugLog("‚ñ∂Ô∏è Starting recording for Hindi/English...");
        mediaRecorder.start(1000);
        
        startBtn.disabled = true;
        stopBtn.disabled = false;
        status.textContent = "üî¥ Recording... (Hindi/English supported)";
        output.innerHTML = `
          <div style="text-align: center; font-size: 20px;">
            üéôÔ∏è <strong>Listening...</strong><br>
            <div style="margin-top: 15px; font-size: 16px;">
              <div class="hindi-text">‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Æ‡•á‡§Ç ‡§¨‡•ã‡§≤‡•á‡§Ç ‡§Ø‡§æ English ‡§Æ‡•á‡§Ç ‡§¨‡•ã‡§≤‡•á‡§Ç</div>
              <div style="margin-top: 10px; opacity: 0.8;">Speak in Hindi or English</div>
            </div>
          </div>
        `;
        recordingIndicator.classList.add('active');

      } catch (error) {
        addDebugLog(`‚ùå Microphone error: ${error.message}`);
        status.textContent = "‚ùå Microphone error: " + error.message;
        output.textContent = "Please allow microphone access and try again.";
      }
    });

    stopBtn.addEventListener("click", () => {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        addDebugLog("‚èπÔ∏è User stopped recording");
        mediaRecorder.stop();
        startBtn.disabled = false;
        stopBtn.disabled = true;
        status.textContent = "‚è≥ Processing Hindi/English audio...";
        recordingIndicator.classList.remove('active');
      }
    });

    // Initialize
    window.addEventListener('load', async () => {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const audioInputs = devices.filter(device => device.kind === 'audioinput');
        addDebugLog(`üé§ Audio inputs available: ${audioInputs.length}`);
        addDebugLog("üåç Language support: Hindi (‡§π‡§ø‡§Ç‡§¶‡•Ä) + English auto-detection enabled");
        
        if (audioInputs.length === 0) {
          status.textContent = "‚ùå No microphone detected";
          startBtn.disabled = true;
        }
      } catch (error) {
        addDebugLog(`‚ö†Ô∏è Device check error: ${error.message}`);
      }
    });
  </script>
</body>
</html>